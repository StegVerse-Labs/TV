name: Token Vault Rotate Key (SCW)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crypto deps
        run: |
          python -m pip install --upgrade pip
          pip install cryptography

      - name: Rotate SCW vault key
        id: rotate
        shell: bash
        run: |
          set -euo pipefail

          NS="SCW"
          VAULT=".github/token_vault/${NS}"
          ENC="${VAULT}/${NS}.enc"
          META="${VAULT}/${NS}.meta.json"

          mkdir -p "${VAULT}"

          python - <<'PY'
import json, os
from pathlib import Path
from cryptography.fernet import Fernet, InvalidToken

ns = "SCW"
vault = Path(".github") / "token_vault" / ns
enc = vault / f"{ns}.enc"
meta = vault / f"{ns}.meta.json"

result = {
    "namespace": ns,
    "enc_exists": enc.exists(),
    "meta_exists": meta.exists(),
    "rotated": False,
    "payload_preserved": False,
    "reason": "",
}

vault.mkdir(parents=True, exist_ok=True)

if not enc.exists() or not meta.exists():
    # If something is missing, create a fresh vault state
    key = Fernet.generate_key().decode()
    fer = Fernet(key)
    cipher = fer.encrypt(b"bootstrap-rotation-fresh")
    enc.write_bytes(cipher)
    meta_data = {"namespace": ns, "fernet_key": key, "note": "created during rotate because files were missing"}
    meta.write_text(json.dumps(meta_data, indent=2), encoding="utf-8")
    result["rotated"] = True
    result["reason"] = "vault files missing; created fresh enc/meta"
else:
    try:
        meta_data = json.loads(meta.read_text(encoding="utf-8"))
        old_key = meta_data.get("fernet_key")
        if not old_key:
            raise RuntimeError("meta.json missing 'fernet_key'")
        old_fer = Fernet(old_key.encode())
        try:
            payload = old_fer.decrypt(enc.read_bytes())
            result["payload_preserved"] = True
        except InvalidToken:
            # keep ciphertext but rotate anyway
            payload = b"rotation-invalid-token"
            result["reason"] = "old decrypt failed; payload replaced with placeholder"

        new_key = Fernet.generate_key().decode()
        new_fer = Fernet(new_key)
        new_cipher = new_fer.encrypt(payload)

        # keep small history of keys
        old_keys = meta_data.get("old_keys") or []
        old_keys.append(old_key)
        meta_data["old_keys"] = old_keys[-5:]  # keep last 5
        meta_data["fernet_key"] = new_key

        enc.write_bytes(new_cipher)
        meta.write_text(json.dumps(meta_data, indent=2), encoding="utf-8")
        result["rotated"] = True
    except Exception as e:
        result["reason"] = f"rotation error: {type(e).__name__}"

out_path = vault / "rotate_result.json"
out_path.write_text(json.dumps(result, indent=2), encoding="utf-8")
print(json.dumps(result, indent=2))
PY

      - name: Commit vault files
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "StegVerse Bot"
          git config user.email "bot@stegverse.org"
          git add .github/token_vault || true
          if ! git diff --cached --quiet; then
            git commit -m "vault: rotate SCW namespace key"
            git push origin HEAD:main
          else
            echo "No vault changes to commit."

      - name: Summary
        if: always()
        run: |
          echo "## Token Vault Rotate Key (SCW)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f ".github/token_vault/SCW/rotate_result.json" ]; then
            echo "Result file: \`.github/token_vault/SCW/rotate_result.json\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No result file was written; see logs for details." >> "$GITHUB_STEP_SUMMARY"
