name: Token Vault Bootstrap (SCW)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crypto deps
        run: |
          python -m pip install --upgrade pip
          pip install cryptography

      - name: Bootstrap SCW token vault
        id: boot
        shell: bash
        run: |
          set -euo pipefail

          NS="SCW"
          VAULT=".github/token_vault/${NS}"
          ENC="${VAULT}/${NS}.enc"
          META="${VAULT}/${NS}.meta.json"
          STATUS=".github/token_vault/${NS}.bootstrap.status.json"

          mkdir -p "${VAULT}"

          python - <<'PY'
import json
from pathlib import Path
from cryptography.fernet import Fernet

ns = "SCW"
vault_root = Path(".github") / "token_vault"
vault_dir = vault_root / ns
enc = vault_dir / f"{ns}.enc"
meta = vault_dir / f"{ns}.meta.json"
status = vault_root / f"{ns}.bootstrap.status.json"

vault_dir.mkdir(parents=True, exist_ok=True)

key = Fernet.generate_key().decode()
fer = Fernet(key)
cipher = fer.encrypt(b"bootstrap-initialized")

enc.write_bytes(cipher)
meta.write_text(
    json.dumps({"namespace": ns, "fernet_key": key}, indent=2),
    encoding="utf-8",
)

status_obj = {
    "namespace": ns,
    "created": True,
    "enc_file": str(enc),
    "meta_file": str(meta),
    "key": key,
}
status.write_text(json.dumps(status_obj, indent=2), encoding="utf-8")

print("BOOTSTRAP_COMPLETE")
PY

      - name: Commit vault files
        if: always()
        run: |
          set -euo pipefail
          if git status --porcelain .github/token_vault | grep .; then
            git config user.name  "StegVerse Bot"
            git config user.email "bot@stegverse.org"
            git add .github/token_vault
            git commit -m "chore(vault): bootstrap SCW token vault"
            git push origin HEAD:main
          else
            echo "No vault changes to commit."
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Token Vault Bootstrap (SCW)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f ".github/token_vault/SCW.bootstrap.status.json" ]; then
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            cat ".github/token_vault/SCW.bootstrap.status.json" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> If **created: true**, you may optionally copy **key** from the JSON above" >> "$GITHUB_STEP_SUMMARY"
            echo "> and store it as repository secret **SCW_VAULT_FERNET_KEY**." >> "$GITHUB_STEP_SUMMARY"
            echo "> After saving the secret, you can run the vault check and rotate workflows." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "_No status file produced; see logs for details._" >> "$GITHUB_STEP_SUMMARY"
