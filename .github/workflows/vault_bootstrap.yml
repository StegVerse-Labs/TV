name: Token Vault Bootstrap (SCW)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crypto deps
        run: |
          python -m pip install --upgrade pip
          pip install cryptography

      - name: Bootstrap SCW token vault
        id: boot
        shell: bash
        run: |
          set -euo pipefail

          NS="SCW"
          VAULT=".github/token_vault/${NS}"
          ENC="${VAULT}/${NS}.enc"
          META="${VAULT}/${NS}.meta.json"

          mkdir -p "${VAULT}"

          python - <<'PY'
import os, json, base64
from cryptography.fernet import Fernet

ns = "SCW"
vault = f".github/token_vault/{ns}"
enc = f"{vault}/{ns}.enc"
meta = f"{vault}/{ns}.meta.json"

key = Fernet.generate_key().decode()
fer = Fernet(key)
cipher = fer.encrypt(b"bootstrap-initialized")

with open(enc, "wb") as f:
    f.write(cipher)

with open(meta, "w") as f:
    json.dump({"namespace": ns, "fernet_key": key}, f, indent=2)

print("BOOTSTRAP_COMPLETE")
PY

      - name: Commit vault files
        if: always()
        run: |
          set -euo pipefail
          if git status --porcelain .github/vault | grep .; then
            git config user.name  "StegVerse Bot"
            git config user.email "bot@stegverse.org"
            git add .github/vault
            git commit -m "chore(vault): bootstrap SCW token vault"
            git push origin HEAD:main
          else
            echo "No vault changes to commit."
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Token Vault Bootstrap (SCW)" >> "$GITHUB_STEP_SUMMARY"
          if [ -f ".github/vault/SCW.bootstrap.status.json" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            cat ".github/vault/SCW.bootstrap.status.json" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> If **created: true**, copy **key** from the JSON above" >> "$GITHUB_STEP_SUMMARY"
            echo "> and store it as repository secret **SCW_VAULT_FERNET_KEY**." >> "$GITHUB_STEP_SUMMARY"
            echo "> After saving the secret, you can run the vault check and rotate workflows." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "_No status file produced; see logs for details._" >> "$GITHUB_STEP_SUMMARY"
