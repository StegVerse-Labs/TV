name: Token Vault Bootstrap (SCW)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crypto deps
        run: |
          python -m pip install --upgrade pip
          pip install cryptography

      - name: Bootstrap SCW token vault
        id: boot
        shell: bash
        run: |
          set -euo pipefail

          NS="SCW"
          VAULT=".github/token_vault/${NS}"
          ENC="${VAULT}/${NS}.enc"
          META="${VAULT}/${NS}.meta.json"

          mkdir -p "${VAULT}"

          python - <<'PY'
import os, json, base64
from cryptography.fernet import Fernet

ns = "SCW"
vault = f".github/token_vault/{ns}"
enc = f"{vault}/{ns}.enc"
meta = f"{vault}/{ns}.meta.json"

key = Fernet.generate_key().decode()
fer = Fernet(key)
cipher = fer.encrypt(b"bootstrap-initialized")

with open(enc, "wb") as f:
    f.write(cipher)

with open(meta, "w") as f:
    json.dump({"namespace": ns, "fernet_key": key}, f, indent=2)

print("BOOTSTRAP_COMPLETE")
PY

      - name: Commit vault files
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "StegVerse Bot"
          git config user.email "bot@stegverse.org"
          git add .github/token_vault || true
          if ! git diff --cached --quiet; then
            git commit -m "vault: bootstrap SCW namespace"
            git push origin HEAD:main
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Token Vault Bootstrap (SCW)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Bootstrap completed. Vault files committed." >> "$GITHUB_STEP_SUMMARY"
