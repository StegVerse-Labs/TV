name: Token Vault Check

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: "Logical namespace to verify"
        required: true
        default: "stegcore"
      deep:
        description: "Deep check: attempt decrypt if ADMIN_TOKEN is available"
        required: true
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      NS: ${{ inputs.namespace }}
      DEEP: ${{ inputs.deep }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crypto deps (for deep decrypt)
        run: python -m pip install --upgrade pip cryptography

      - name: Verify vault structure + (optional) decrypt
        id: verify
        shell: bash
        env:
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN || '' }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, json, base64, pathlib, sys
          from pathlib import Path

          NS   = os.environ["NS"]
          DEEP = os.environ["DEEP"].lower() == "true"
          ADMIN_TOKEN = os.environ.get("ADMIN_TOKEN","")

          root = Path(".")
          vault_dir = root/".github"/"vault"
          enc_path  = vault_dir/f"token_vault.{NS}.enc"
          meta_path = vault_dir/f"token_vault.{NS}.meta.json"

          out_dir = root/".github"/"autopatch_out"
          out_dir.mkdir(parents=True, exist_ok=True)
          out_path = out_dir/f"VAULT_CHECK_{NS}.json"

          status = {
            "namespace": NS,
            "enc_exists": enc_path.exists(),
            "meta_exists": meta_path.exists(),
            "meta_valid_json": False,
            "deep_checked": False,
            "deep_ok": False,
            "reason": None,
          }

          if not enc_path.exists() or not meta_path.exists():
            status["reason"] = "missing enc or meta file"
            out_path.write_text(json.dumps(status, indent=2), encoding="utf-8")
            print(json.dumps(status, indent=2))
            sys.exit(0)

          try:
            meta = json.loads(meta_path.read_text(encoding="utf-8"))
            status["meta_valid_json"] = True
          except Exception as e:
            status["reason"] = f"meta JSON parse failed: {type(e).__name__}"
            out_path.write_text(json.dumps(status, indent=2), encoding="utf-8")
            print(json.dumps(status, indent=2))
            sys.exit(0)

          if not DEEP:
            status["reason"] = "shallow check only"
            out_path.write_text(json.dumps(status, indent=2), encoding="utf-8")
            print(json.dumps(status, indent=2))
            sys.exit(0)

          if not ADMIN_TOKEN:
            status["deep_checked"] = False
            status["reason"] = "no ADMIN_TOKEN; cannot attempt decrypt"
            out_path.write_text(json.dumps(status, indent=2), encoding="utf-8")
            print(json.dumps(status, indent=2))
            sys.exit(0)

          # Deep decrypt attempt
          from cryptography.hazmat.primitives.kdf.scrypt import Scrypt
          from cryptography.hazmat.primitives.ciphers.aead import AESGCM

          try:
            salt  = base64.b64decode(meta["salt_b64"])
            nonce = base64.b64decode(meta["nonce_b64"])
          except Exception as e:
            status["reason"] = f"meta salt/nonce decode failed: {type(e).__name__}"
            out_path.write_text(json.dumps(status, indent=2), encoding="utf-8")
            print(json.dumps(status, indent=2))
            sys.exit(0)

          enc = enc_path.read_bytes()
          try:
            kdf = Scrypt(salt=salt, length=32, n=2**14, r=8, p=1)
            key = kdf.derive(ADMIN_TOKEN.encode())
            aes = AESGCM(key)
            plain = aes.decrypt(nonce, enc, associated_data=NS.encode())
            # validate payload is JSON
            payload = json.loads(plain.decode())
            status["deep_checked"] = True
            status["deep_ok"] = True
            status["payload_keys"] = list(payload.keys())
          except Exception as e:
            status["deep_checked"] = True
            status["deep_ok"] = False
            status["reason"] = f"decrypt or JSON parse failed: {type(e).__name__}"

          out_path.write_text(json.dumps(status, indent=2), encoding="utf-8")
          print(json.dumps(status, indent=2))
          PY

      - name: Summary
        if: always()
        run: |
          echo "## Token Vault Check" >> "$GITHUB_STEP_SUMMARY"
          NS="${{ inputs.namespace }}"
          FILE=".github/autopatch_out/VAULT_CHECK_${NS}.json"
          if [ -f "$FILE" ]; then
            cat "$FILE" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "_No check summary written._" >> "$GITHUB_STEP_SUMMARY"
