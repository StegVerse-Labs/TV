name: Token Vault Check (SCW)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install crypto deps (for deep decrypt)
        run: |
          python -m pip install --upgrade pip
          pip install cryptography

      - name: Verify vault structure + (optional) decrypt
        id: verify
        shell: bash
        run: |
          set -euo pipefail

          NS="SCW"
          VAULT=".github/token_vault/${NS}"
          ENC="${VAULT}/${NS}.enc"
          META="${VAULT}/${NS}.meta.json"

          mkdir -p "${VAULT}"

          python - <<'PY'
import os, json
from pathlib import Path
from cryptography.fernet import Fernet, InvalidToken

ns = "SCW"
vault = Path(".github") / "token_vault" / ns
enc = vault / f"{ns}.enc"
meta = vault / f"{ns}.meta.json"

result = {
    "namespace": ns,
    "enc_exists": enc.exists(),
    "meta_exists": meta.exists(),
    "meta_valid_json": False,
    "deep_checked": False,
    "deep_ok": False,
    "reason": "",
}

if not result["enc_exists"] or not result["meta_exists"]:
    result["reason"] = "missing enc or meta file"
else:
    try:
        meta_data = json.loads(meta.read_text(encoding="utf-8"))
        result["meta_valid_json"] = True
        key = meta_data.get("fernet_key")
        if not key:
            result["reason"] = "meta.json missing 'fernet_key'"
        else:
            result["deep_checked"] = True
            fer = Fernet(key.encode())
            try:
                payload = enc.read_bytes()
                _ = fer.decrypt(payload)
                result["deep_ok"] = True
            except InvalidToken:
                result["reason"] = "fernet decrypt failed (InvalidToken)"
            except Exception as e:
                result["reason"] = f"fernet decrypt error: {type(e).__name__}"
    except Exception as e:
        result["reason"] = f"meta.json parse error: {type(e).__name__}"

out_path = vault / "check_result.json"
out_path.write_text(json.dumps(result, indent=2), encoding="utf-8")
print(json.dumps(result, indent=2))
PY

      - name: Summary
        if: always()
        run: |
          echo "## Token Vault Check (SCW)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f ".github/token_vault/SCW/check_result.json" ]; then
            echo "Result file: \`.github/token_vault/SCW/check_result.json\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No result file was written; see logs for details." >> "$GITHUB_STEP_SUMMARY"
